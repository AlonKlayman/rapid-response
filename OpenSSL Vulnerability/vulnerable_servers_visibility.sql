-- This query detects potentially vulnerable servers by following filters:
-- 1. Servers running on OS which contain vulnerable version of OpenSSL by default
-- 2. Servers where OpenSSL was observed running (therefore may indicate for vulnerable version)
-- The query identifies external-facing servers and sensitive assets based on EDR logs and Hunters relevant sources

WITH EXTERNAL_FACING_AGENTS as
         (SELECT DISTINCT AGENT_ID
          FROM INVESTIGATION.EDR_NETWORK_EVENTS
          WHERE EVENT_TIME >= CURRENT_TIMESTAMP - INTERVAL '30 days'
            AND IS_INBOUND = TRUE
            AND NOT regexp_like(REMOTE_IP,
                                -- possible IPv4-Mapped prefix for IPv6
                                '(::ffff:)?'             ||
                                -- non-public IPs
                                '((0\\.0\\.0\\.0)|'      ||
                                '(127\\..*)|'            ||
                                '(192\\.168\\..*)|'      ||
                                '(169\\.254\\..*)|'      ||
                                '(10\\..*)|'             ||
                                '(172\\.1[6-9]\\..*)|'   ||
                                '(172\\.2[0-9]\\..*)|'   ||
                                '(172\\.3[0-1]\\..*)|'   ||
                                '(::1.*)|'               ||
                                '(0:0:0:0:0:0:0:1)|'     ||
                                '(fe80:.*)|'             ||
                                '(fc.*)|'                ||
                                '(fd.*))'))
SELECT EDR_AGENT_INFO.LAST_HOSTNAME                                       AS HOSTNAME,
       EDR_AGENT_INFO.AID                                                 AS AGENT_ID,
       EDR_AGENT_INFO.OS_TYPE                                             AS OS_TYPE,
       EDR_AGENT_INFO.LAST_OS_VERSION                                     AS OS_VERSION,
       -- os versions that are vulnerable due to their default version of OpenSSL
       -- reference - https://isc.sans.edu/forums/diary/Upcoming+Critical+OpenSSL+Vulnerability+What+will+be+Affected/29192
       LAST_OS_VERSION ILIKE ANY ('%CentOS Stream 9%', '%fedora 36%',
                                  '%fedora rawhide%', '%Rocky 9.0%',
                                  '%kali 2022.3%', '%openmandriva cooker%',
                                  '%vanessa%', '%mageia cauldron%',
                                  '%openmandriva 4.3%', '%mint 21%',
                                  '%redhat es 9%', '%redhat 9%',
                                  '%bluonyx%', '%ubuntu 22.04%',
                                  'linux 22.04', '%linux 22.10%',
                                  '%ubuntu 22.10%', '%rhel 9%',
                                  '%CentOS 9%')                           AS VULNERABLE_OS,
       AID IN (SELECT AGENT_ID FROM EXTERNAL_FACING_AGENTS)               AS EXTERNAL_FACING,
       ARRAY_AGG(DISTINCT ASSET_TAGGING.ASSET_TAG)                        AS SENSITIVITY,
       TARGET_PROCESS_PATH                                                AS PROCESS_PATH,
       IFNULL(MAX(EVENT_TIME)::VARCHAR, 'No Execution took place')        AS LAST_EXECUTION,
       IFNULL(TARGET_PROCESS_HASH_SHA256, 'No Execution took place')      AS BINARY_HASH
FROM INVESTIGATION.EDR_PROCESS_CREATION_EVENTS
         RIGHT JOIN INVESTIGATION.EDR_AGENT_INFO ON EDR_AGENT_INFO.AID = EDR_PROCESS_CREATION_EVENTS.AGENT_ID AND
                                                    EDR_PROCESS_CREATION_EVENTS.TARGET_PROCESS_NAME ILIKE '%openssl%' AND
                                                    EDR_PROCESS_CREATION_EVENTS.EVENT_TIME >= CURRENT_TIMESTAMP - interval '30 days'
         LEFT JOIN INVESTIGATION.ASSET_TAGGING ON KIND = 'agent_id' and VALUE = EDR_AGENT_INFO.AID

WHERE EDR_AGENT_INFO.LAST_SEEN >= CURRENT_TIMESTAMP - interval '30 days'
GROUP BY AID, LAST_HOSTNAME, OS_TYPE,TARGET_PROCESS_PATH, LAST_OS_VERSION, TARGET_PROCESS_HASH_SHA256
HAVING NOT LAST_EXECUTION = 'No Execution took place' OR VULNERABLE_OS
ORDER BY EXTERNAL_FACING DESC, VULNERABLE_OS DESC)
