--This query identifies server running Java processes which utilizes the vulnerable Apache Commons Text library based on commandline. In addition the query indicate for external-facing server based on inbound connections from external IPs.

WITH affected as (
    SELECT AGENT_ID,
           TARGET_PROCESS_COMMANDLINE,
           ARRAY_AGG(DISTINCT TARGET_PROCESS_PATH)                                                      processes_paths,
           MAX(EVENT_TIME)                                                                              last_seen,
           -- sensitivity validation based on asset tagging feature
    FROM INVESTIGATION.EDR_PROCESS_CREATION_EVENTS
    WHERE TARGET_PROCESS_NAME ilike '%java%'
      -- java process loads 'commons-text' Apache Commons Text library
      AND INVESTIGATION.EDR_PROCESS_CREATION_EVENTS.TARGET_PROCESS_COMMANDLINE ilike '%commons-text%'
      -- exclusion of relevant IDEs, add more filters if required
      AND NOT TARGET_PROCESS_PATH ilike '%IntelliJ%'
      -- adjust time-frame
      AND EVENT_TIME >= CURRENT_TIMESTAMP - INTERVAL '7 days'
    GROUP BY 1, 2
),
     net_con as (
         SELECT affected.AGENT_ID,
                REMOTE_IP,
                -- counter to find requests from external sources
                COUNT(DISTINCT net.REMOTE_IP) > 0 external_facing
         FROM affected
                  LEFT JOIN INVESTIGATION.EDR_NETWORK_EVENTS net
                            ON (affected.AGENT_ID = net.AGENT_ID AND
                             -- adjust time-frame
                                net.EVENT_TIME >= CURRENT_TIMESTAMP - INTERVAL '7 days' AND
                                net.IS_INBOUND = TRUE AND
                                -- internal IPs exclusion based on rfc6890 (IPv4 and IPv6 based), add more filters if your organization reserved external IP addresses for internal usage
                                NOT REGEXP_LIKE(net.REMOTE_IP, '(^0\.)|(^10\..*)|(^100\.6[4-9]\..*)|(^100\.[7-9].*)|(^100\.1[0-1].*)|(^100\.12[0-7]\..*)|(^127\..*)|(^169\.254\..*)|(^172\.1[6-9]\..*)|(^172\.2[0-9]\..*)|(^172\.3[0-1]\..*)|(^192\.0\.0\..*)|(^192\.0\.2\..*)|(^192\.88\.99\..*)|(^192\.168\..*)|(^198\.1[8-9]\..*)|(^198\.51\.100\..*)|(^203.0\.113\..*)|(^22[4-9]\..*)|(^23[0-9]\..*)|(^24[0-9]\..*)|(^25[0-5]\.|0.0.0.0|(^::1$.*)|(^[fF](([cCdD])|([Eefe]80:)).*))|^([0-9A-Fa-f]{0,4}:){2,7}([0-9A-Fa-f]{1,4}$|((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4})$'))
         GROUP BY 1, 2
     )
SELECT distinct IFF(LAST_HOSTNAME IS NULL, '<Hostname not found>', LAST_HOSTNAME)                                   as hostname,
                affected.AGENT_ID                                                                                   as agent_id,
                IFF(EDR_AGENT_INFO.LAST_EXTERNAL_IP_ADDRESS IS NULL, '<IP not found>', LAST_EXTERNAL_IP_ADDRESS)    as external_ip,
                processes_paths,
                ARRAY_AGG(distinct REGEXP_SUBSTR(TARGET_PROCESS_COMMANDLINE, 'commons-text-[^;:]+\.jar'))           as commons_text_core_versions,
                ARRAY_AGG(distinct REGEXP_SUBSTR(TARGET_PROCESS_COMMANDLINE, 'jdk-[\\w.]+\.jdk'))                   as jdk_version_unix,
                external_facing,
                MAX(affected.LAST_SEEN)                                                                             as last_seen
FROM affected
         LEFT JOIN INVESTIGATION.EDR_AGENT_INFO ON (affected.AGENT_ID = EDR_AGENT_INFO.AID)
         JOIN net_con ON (affected.AGENT_ID = net_con.AGENT_ID)
GROUP BY hostname,
         affected.AGENT_ID,
         external_ip,
         processes_paths,
         external_facing
