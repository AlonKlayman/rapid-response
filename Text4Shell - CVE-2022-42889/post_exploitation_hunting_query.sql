--The query detects commonly abused binaries that are executed by a Java process (either for Windows or Unix) followed by an external network connection, a behaviour which is related to reverse-shells. 

WITH NETWORK_CONNECTIONS AS (SELECT INITIATING_PROCESS_UID, REMOTE_IP, REMOTE_PORT
                             FROM INVESTIGATION.EDR_NETWORK_EVENTS
                             WHERE INITIATING_PROCESS_NAME ILIKE '%java%'
                               -- filter out internal IPs requests
                               AND IS_INBOUND = FALSE
                               AND NOT REGEXP_LIKE(REMOTE_IP, '(^0\.)|' ||
                                                              '(^10\..*)|' ||
                                                              '(^100\.6[4-9]\..*)|' ||
                                                              '(^100\.[7-9].*)|' ||
                                                              '(^100\.1[0-1].*)|' ||
                                                              '(^100\.12[0-7]\..*)|' ||
                                                              '(^127\..*)|' ||
                                                              '(^169\.254\..*)|' ||
                                                              '(^172\.1[6-9]\..*)|' ||
                                                              '(^172\.2[0-9]\..*)|' ||
                                                              '(^172\.3[0-1]\..*)|' ||
                                                              '(^192\.0\.0\..*)|' ||
                                                              '(^192\.0\.2\..*)|' ||
                                                              '(^192\.88\.99\..*)|' ||
                                                              '(^192\.168\..*)|' ||
                                                              '(^198\.1[8-9]\..*)|' ||
                                                              '(^198\.51\.100\..*)|' ||
                                                              '(^203.0\.113\..*)|' ||
                                                              '(^22[4-9]\..*)|' ||
                                                              '(^23[0-9]\..*)|' ||
                                                              '(^24[0-9]\..*)|' ||
                                                              '(^25[0-5]\.|' ||
                                                              '0.0.0.0|' ||
                                                              '(^::1$.*)|' ||
                                                              '(^[fF](([cCdD])|' ||
                                                              '([Eefe]80:)).*))|' ||
                                                              '^([0-9A-Fa-f]{0,4}:){2,7}([0-9A-Fa-f]{1,4}$|' ||
                                                              '((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4})$')
                               -- 3 days lookup
                               AND EVENT_TIME >= CURRENT_TIMESTAMP - INTERVAL '3 days')
SELECT MIN(PROCESS_CREATION.EVENT_TIME)                                     AS START_TIME,
       MAX(PROCESS_CREATION.EVENT_TIME)                                     AS END_TIME,
       PROCESS_CREATION.AGENT_ID                                            AS AGENT_ID,
       AGENT_INFO.LAST_HOSTNAME                                             AS HOSTNAME,
       PROCESS_CREATION.DEVICE_PLATFORM                                     AS DEVICE_PLATFORM,
       PROCESS_CREATION.INITIATING_PROCESS_NAME                             AS INITIATING_PROCESS,
       PROCESS_CREATION.TARGET_PROCESS_NAME                                 AS TARGET_PROCESS_NAME,
       PROCESS_CREATION.TARGET_PROCESS_COMMANDLINE                          AS TARGET_PROCESS_COMMANDLINE,
       ARRAY_AGG(DISTINCT IFNULL(CONCAT(NETWORK_CONNECTIONS.REMOTE_IP
                                 || ':' ||
                                 NETWORK_CONNECTIONS.REMOTE_PORT),
                                 NETWORK_CONNECTIONS.REMOTE_IP))            AS REMOTE_CONNECTIONS
  FROM INVESTIGATION.EDR_PROCESS_CREATION_EVENTS AS PROCESS_CREATION
  INNER JOIN NETWORK_CONNECTIONS ON  NETWORK_CONNECTIONS.INITIATING_PROCESS_UID = PROCESS_CREATION.TARGET_PROCESS_UID
  LEFT JOIN INVESTIGATION.EDR_AGENT_INFO AGENT_INFO ON (AGENT_INFO.AID = PROCESS_CREATION.AGENT_ID)
 -- network connections to an external ip address
 WHERE PROCESS_CREATION.INITIATING_PROCESS_NAME ILIKE '%java%'
   AND ((PROCESS_CREATION.DEVICE_PLATFORM = 'WINDOWS' AND LOWER(PROCESS_CREATION.TARGET_PROCESS_NAME) IN ('bitsadmin.exe', 'certutil.exe', 'cmd.exe','powershell.exe') OR
        (NOT PROCESS_CREATION.DEVICE_PLATFORM = 'WINDOWS' AND LOWER(PROCESS_CREATION.TARGET_PROCESS_NAME)  IN ('sh', 'bash','wget', 'curl'))))
   -- 3 days lookup
   AND PROCESS_CREATION.EVENT_TIME > CURRENT_TIMESTAMP - INTERVAL '3 days'
GROUP BY PROCESS_CREATION.AGENT_ID,
         PROCESS_CREATION.DEVICE_PLATFORM,
         PROCESS_CREATION.TARGET_PROCESS_NAME,
         PROCESS_CREATION.INITIATING_PROCESS_NAME,
         PROCESS_CREATION.TARGET_PROCESS_COMMANDLINE,
         HOSTNAME
