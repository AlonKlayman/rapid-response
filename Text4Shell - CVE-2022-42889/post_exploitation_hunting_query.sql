--The query detects commonly abused binaries that are executed by a Java process (either for Windows or Unix) followed by an external network connection, a behaviour which is related to reverse-shells. 

SELECT MIN(PROCESS_CREATION.EVENT_TIME)                                     START_TIME,
       MAX(PROCESS_CREATION.EVENT_TIME)                                     END_TIME,
       PROCESS_CREATION.AGENT_ID                                            AGENT_ID,
       AGENT_INFO.LAST_HOSTNAME                                             HOSTNAME,
       PROCESS_CREATION.DEVICE_PLATFORM                                     DEVICE_PLATFORM,
       PROCESS_CREATION.INITIATING_PROCESS_NAME                             INITIATING_PROCESS,
       PROCESS_CREATION.TARGET_PROCESS_NAME                                 TARGET_PROCESS_NAME,
       PROCESS_CREATION.TARGET_PROCESS_COMMANDLINE                          TARGET_PROCESS_COMMANDLINE,
       ARRAY_AGG(DISTINCT
         IFNULL(
             CONCAT(NETWORK_EVENTS.REMOTE_IP || ':' || NETWORK_EVENTS.REMOTE_PORT),
             NETWORK_EVENTS.REMOTE_IP))     REMOTE_CONNECTIONS
  FROM INVESTIGATION.EDR_PROCESS_CREATION_EVENTS PROCESS_CREATION
 INNER JOIN INVESTIGATION.EDR_NETWORK_EVENTS NETWORK_EVENTS ON (NETWORK_EVENTS.INITIATING_PROCESS_UID = PROCESS_CREATION.TARGET_PROCESS_UID
   -- filiter for outbound requests 
   AND IS_INBOUND=FALSE
   AND NOT REGEXP_LIKE(NETWORK_EVENTS.REMOTE_IP,'(^0\.)|(^10\..*)|(^100\.6[4-9]\..*)|(^100\.[7-9].*)|(^100\.1[0-1].*)|(^100\.12[0-7]\..*)|(^127\..*)|(^169\.254\..*)|(^172\.1[6-9]\..*)|(^172\.2[0-9]\..*)|(^172\.3[0-1]\..*)|(^192\.0\.0\..*)|(^192\.0\.2\..*)|(^192\.88\.99\..*)|(^192\.168\..*)|(^198\.1[8-9]\..*)|(^198\.51\.100\..*)|(^203.0\.113\..*)|(^22[4-9]\..*)|(^23[0-9]\..*)|(^24[0-9]\..*)|(^25[0-5]\.|0.0.0.0|(^::1$.*)|(^[fF](([cCdD])|([Eefe]80:)).*))|^([0-9A-Fa-f]{0,4}:){2,7}([0-9A-Fa-f]{1,4}$|((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4})$')
   -- network connections with 15 minutes interval from the process execution time
   AND NETWORK_EVENTS.EVENT_TIME between DATEADD(MINUTE, -15, PROCESS_CREATION.EVENT_TIME) and DATEADD(MINUTE, 15, PROCESS_CREATION.EVENT_TIME))
 LEFT JOIN INVESTIGATION.EDR_AGENT_INFO AGENT_INFO ON (AGENT_INFO.AID = PROCESS_CREATION.AGENT_ID)
   -- network connections to an external ip address
 WHERE PROCESS_CREATION.INITIATING_PROCESS_NAME ILIKE '%java%'
   -- windows
   AND CASE WHEN PROCESS_CREATION.DEVICE_PLATFORM = 'WINDOWS' THEN LOWER(PROCESS_CREATION.TARGET_PROCESS_NAME) IN ('bitsadmin.exe', 'certutil.exe', 'cmd.exe','powershell.exe')
          -- unix
          ELSE LOWER(PROCESS_CREATION.TARGET_PROCESS_NAME)  IN ('sh', 'bash','wget', 'curl')
        END
   -- adjust time-frame
   AND PROCESS_CREATION.EVENT_TIME > CURRENT_TIMESTAMP - INTERVAL '3d'
GROUP BY PROCESS_CREATION.AGENT_ID,
         PROCESS_CREATION.DEVICE_PLATFORM,
         PROCESS_CREATION.TARGET_PROCESS_NAME,
         PROCESS_CREATION.INITIATING_PROCESS_NAME,
         PROCESS_CREATION.TARGET_PROCESS_COMMANDLINE,
         HOSTNAME
